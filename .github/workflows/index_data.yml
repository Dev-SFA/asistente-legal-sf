name: Generar y Subir Índice de Datos

on:
  workflow_dispatch:
    # Permite ejecutar este flujo manualmente desde la pestaña 'Actions'
  push:
    branches:
      - main
    paths:
      # Se activa automáticamente si cambias el script de indexación, las dependencias o los documentos
      - 'index_data.py'
      - 'requirements.txt'
      - 'data/**' 

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: 1. Checkout Código
      uses: actions/checkout@v4
      with:
        # Permite que el Action haga commit de la carpeta 'storage' de vuelta al repo
        token: ${{ secrets.GITHUB_TOKEN }} 
        
    - name: 2. Configurar Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: 3. Instalar Dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: 4. Ejecutar Indexación y Crear Carpeta 'storage'
      # La clave se inyecta de forma segura desde los Secretos de GitHub
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: python index_data.py

    - name: 5. Subir Archivos del Índice a GitHub
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action Bot"
        # Agrega la carpeta storage al control de versiones
        git add storage/
        # Intenta commitear. El || echo evita que falle si no hay cambios.
        git commit -m "chore: Indices de Llama Index actualizados (Action)" || echo "No hay cambios en el índice para commitear"
        # Sube los cambios al repositorio (incluyendo la nueva carpeta storage/)
        git push
