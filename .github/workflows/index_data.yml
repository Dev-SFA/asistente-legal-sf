name: Generar y Subir Indice de Datos

on:
  # Permite ejecutar el workflow manualmente desde la interfaz de GitHub
  workflow_dispatch:
  # ------------------------------------------------------------------
  # DESACTIVADO: La indexación ya no se ejecutará en cada push.
  # Se ejecuta SÓLO manualmente (workflow_dispatch) para evitar costos.
  # ------------------------------------------------------------------
  # push:
  #   branches:
  #     - main
  #     - master

jobs:
  index_data:
    # Corre en el último ambiente de Ubuntu disponible
    runs-on: ubuntu-latest
    
    # Define las variables de entorno para las claves secretas
    env:
      # Las variables de entorno son leídas desde los Secrets de tu repositorio
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
      PINECONE_ENVIRONMENT: ${{ secrets.PINECONE_ENVIRONMENT }} # Se mantiene por compatibilidad

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # Versión recomendada para LLM stacks

      - name: Instalar Dependencias
        run: pip install -r requirements.txt

      - name: Ejecutar Script de Indexación (Sube a Pinecone)
        # Este es el paso que corre tu index_data.py
        # y que se encargará de la larga tarea de generar los embeddings
        run: python index_data.py

      # ----------------------------------------------------------------------
      # PASOS DE GIT ELIMINADOS:
      # Ya no se intenta hacer 'git add storage/' ni 'git commit' porque
      # los vectores se suben directamente a la nube de Pinecone,
      # lo que causaba el error 'fatal: pathspec 'storage/' did not match any files' (código 128).
      # ----------------------------------------------------------------------

      - name: Proceso de Indexación Finalizado
        run: echo "El script de indexación finalizó con éxito. Revisa el log para ver el progreso de subida a Pinecone."
